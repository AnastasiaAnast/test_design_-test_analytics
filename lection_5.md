# Диаграммы и таблицы переходов состояний

- Что такое _техника_ переходов состояний?
- Когда, зачем нужна?
- Пример: составление _диаграммы_ переходов состояний.
- Пример: составление _таблицы_ переходов состояний.
- Составление _тестовых сценариев_ в результате применения техники переходов состояний

## Диаграмма переходов состояний

— **техника тест-дизайна** для систем, изменяющих характеристики в зависимости от внешних стимулов. Система принимает состояние, в котором находится до тех пор, пока не получит стимул для дальнейшего изменения своего состояния.

## Диаграмма переходов состояний: use case

- 3 **агента**: система, пользователь, контролер;
- в сценарии есть **объект** - билет (над которым проводятся операции);
- **условия** - оплачен ли заказ, истекло ли время брони;
- **ошибки чаще всего появляются при нарушении условий**;
- для наглядного представления сценариев, выявления негативных/нестандартных кейсов исп. диаграмму переходов сосотояния, таблицы переходов состояний;

Вариант 1
Пользователь: оформляет заказ на билет (предоставляет
данные)
Система: создаёт бронь
Система: запускает таймер, до истечения которого нужно оплатить билет
Пользователь: оплачивает билет
Система: выпускает билет
Контролер: принимает билет
Система: погашает билет

Вариант 2
Пользователь: оформляет заказ на билет (предоставляет
данные)
Система: создаёт бронь
Система: запускает таймер, до истечения которого нужно
оплатить билет
Пользователь: не оплатил билет до окончания таймера
Система: отменяет бронь

Вариант 3
Пользователь: оформляет заказ на билет (предоставляет данные)
Система: создаёт бронь
Система: запускает таймер, до истечения которого нужно
оплатить билет
Пользователь: отменил заказ до окончания таймера
Система: отменяет бронь

Вариант 4
Пользователь: оформляет заказ на билет (предоставляет данные)
Система: создаёт бронь
Система: запускает таймер, до истечения которого нужно
оплатить билет
Пользователь: оплачивает билет
Пользователь: возвращает билет
Система: оформляет возврат

## Элементы диаграммы переходов состояний

![elements of diagram](/elements.png)

- **Точка входа** — пользователь _ещё не взаимодействует_ с системой
- **Cостояние** — круг с названием состояния, состояние приложения, в которое система пришла вследствие действий пользователя; в нем она ожидает одно/более событий, которые изменят это состояние; входные данные, полученные до перехода в это состояние запоминаются, состояние показывает, как приложение должно реагировать на действия извне
- **Стрелки** — переход от одного состояния к другому
- **События** — то, что _приходит в систему извне_ и запускает изменение состояния (например, пользователь оплатил заказ); _пишется над стрелкой_
- **Действие** — то, что _происходит внутри системы_ из-за смены состояния (например, запуск таймера). Представлено _ярлыком над стрелкой после события_. При наличии события отделяется от него косой чертой (/) - сначала событие, потом - действие. Может быть и только одно действие, без события - будет указано просто ярлыком над стрелкой. Чаще всего действия создают что-то, что явл входными/возвращающими данными системы. Действия возникают при переходах, сами по себе состояния пассивные, действия - активные. Действия - следствия события, которые происходят практически одновременно с событием.
- **Точка выхода** — на диаграмме в виде мишени - взаимодействие с системой окончено, изменение состояния невозможно

## 4 уровня тестового покрытия

Как составить тесты, чтобы тестовое покрытие было _оптимальным_ - _захватило все сценарии, которые необходимо покрыть_. 4 варианта развития событий - 4 ур-ня покрытия.

1. Каждое _состояние_ затрагивает хотя бы один тест. Неоптимальный вариант. Проверяем все состояния, но не проверяем все события и действия, не покрывается проверками возврат денег.
2. Каждое _событие_ вызывается хотя бы в одном тесте. Неоптимальный вариант. Проверяем все события, но не проверяем все состояния и действия.
3. Каждый _путь_ исполняется хотя бы в одном тесте.
   Если в диаграмме есть циклы, кол-во возможных путей
   становится бесконечным. Например, если есть два
   состояния (А и В), и есть переходы из состояния А в В и
   обратно из В в А, то возможны пути:
   a. А → В
   b. А → В → А
   c. А → В → А → В → А → В → А → В → А …
   Важно тестировать циклы, так как в них могут накапливаться
   ошибки/происходить утечки памяти.

   Проверяем переход, а не путь.

4. Каждый переход используется хотя бы в одном тесте.
   Этот уровень тестового покрытия оптимален, так как
   затронет все состояния, действия и события. Он может
   совпадать с покрытием всех возможных путей. В этом
   случае мы получим следующий набор тестовых сценариев:
   ➜ Использование оплаченного билета
   (Забронирован — Оплачен — Выпущен — Использован)
   ➜ Отмена брони по неоплате
   (Забронирован — Отменен по неоплате)
   ➜ Отмена брони покупателем
   (Забронирован — Отменен покупателем)
   ➜ Отмена покупателем после оплаты
   (Забронирован — Оплачен — Отменен)
   ➜ Отмена покупателем после выпуска
   (Забронирован — Оплачен — Выпущен — Отменен)

## Таблица переходов состояний

"все ко всем"

— лучше систематизируют сведения о системе.
Состоят из 4-х колонок:

- текущее состояние (то, в котором предположительно находимся сейчас)
- событие (то, которое может произойти)
- действие (то, которое сопряжено с событием)
- новое состояние (на какое состояние изменится состояние системы - стенет новым/останется текущим)

| Текущее состояние | Событие                     | Действие          | Новое состояние |
| ----------------- | --------------------------- | ----------------- | --------------- |
| null              | Указать персональные данные | Стартовать таймер | Забронирован    |

## Алгоритм составоения таблицы переходов состояний

1. Сопоставить состояния и события по принципу «все ко всем» и заполнить столбцы «Текущее состояние», «Событие».
2. Там, где смена состояний вызывает действие, заполнить столбец «Действия»
3. В каждой строке указать новое состояние. Если событие не ведёт к смене состояния, то новое состояние совпадает с текущим.

![table](/table1.png)
![table_continuation](/table2.png)

## Алгоритм составления тестов по таблице переходов состояний

1. Выделить зелёным все возможные переходы (позитивные проверки).
2. Выявить невозможные переходы, которые несут риски, и выделить их красным. Это будут _негативные проверки_. Для выявления риско тестировщики советуются с разработчиками/аналитиками.
3. При покупке билетов существуют риски:

- покупатель использует неоплаченный, невыпущенный, ранее использованный, отменённый билет,
- покупатель оплатит билет после отмены брони.

## Требования для функциональности

Пример «Публикация поста»
![post](/post.png)
Поле создания поста выглядит так:

- есть поле ввода текста
- значок добавления эмоджи
- выбор времени публикации (сейчас/по календарю)
- выбор тематики поста
- выбор фона (можно выбрать картинку из предложенных или загрузить свою)
- добавление фото, видео, музыки, статьи, файла, карты, граффити, опроса (часть пунктов может быть скрыта в выпадающем списке «ещё»)
- настройка публикации
- кнопка «Опубликовать»

![diagram_post](/diagram1.png)

После ввода текста и нажатия на кнопку «Опубликовать», пост будет создан в системе. Затем он сразу автоматически отправится на модерацию. Пока пост на модерации, его не видят другие пользователи, но видит автор. В это время он может его удалить или отредактировать. После сохранения изменений пост будет повторно отправлен на модерацию. Если модерация отклонила пост, он возвращается автору на исправление и повторную публикацию. Если модерация одобрила пост, он становится видимым всем пользователям системы. Автору доступно удаление и редактирование поста. После редактирования пост снова отправляется на модерацию.

Таблица переходов состояний для "Публикации поста"

![table_post1](/table_post1.png)
![table_post2](/table_post2.png)
![table_post3](/table_post3.png)
![table_post4](/table_post4.png)
